from ipaddress import IPv4Address

from simulation_models.cyborg.CybORG.Shared import Observation
from simulation_models.cyborg.CybORG.Simulator.Actions.ConcreteActions.ExploitActions.ExploitAction import ExploitAction
from simulation_models.cyborg.CybORG.Shared.Enums import OperatingSystemPatch, OperatingSystemType
from simulation_models.cyborg.CybORG.Simulator.Host import Host
from simulation_models.cyborg.CybORG.Simulator.Process import Process
from simulation_models.cyborg.CybORG.Simulator.State import State


class EternalBlue(ExploitAction):
    def __init__(self, session: int, agent: str, ip_address: IPv4Address):
        super().__init__(session, agent, ip_address)

    def execute(self, state: State, **kwargs) -> Observation:
        return self.sim_exploit(state, 139, 'smb')

    def test_exploit_works(self, target_host: Host, vuln_proc: Process, **kwargs):
        # check if OS and process information is correct for exploit to work
        correct_os = target_host.os_type == OperatingSystemType.WINDOWS
        unpatched = OperatingSystemPatch.MS17_010 not in target_host.patches

        return correct_os and unpatched
